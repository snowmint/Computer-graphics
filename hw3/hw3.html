<!DOCTYPE html>

<html>

<head>
<style>
	body {
	  font-family: Monospace;
	  background-color: #000;
	  color: #fff;
	  margin: 0px;
	  overflow: hidden;
	}

	#info {
	  color: #fff;
	  position: absolute;
	  top: 10px;
	  width: 100%;
	  text-align: center;
	  z-index: 100;
	  display: block;
	}

	#info a,
	.button {
	  color: #f00;
	  font-weight: bold;
	  text-decoration: underline;
	  cursor: pointer
	}


</style>
</head>

<body> 
	<div id="info">
	    OBJLoader + MTLLoader
	</div>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/107/three.min.js"></script>
	<script src="http://threejs.org/build/three.min.js"></script>
    <script src="http://threejs.org/examples/js/loaders/MTLLoader.js"></script>
    <script src="http://threejs.org/examples/js/loaders/OBJLoader.js"></script>
    <script src="https://threejs.org/examples/js/controls/OrbitControls.js"></script>
    <script src="https://jyunming-chen.github.io/tutsplus/js/KeyboardState.js"></script>

<script>
var camera1, camera2, scene, renderer;
var controls, obj_car;
var keyboard = new KeyboardState();
var clock, useOne = true;
var pos = new THREE.Vector3();
var speed, angle = 0.01, vel;
var theObjectAll, yellow_box;

(function() {
    Math.clamp = function(val,min,max){
        return Math.min(Math.max(val,min),max);
    }
})();

init();
animate();

function init() {
    clock = new THREE.Clock();
    clock_ball = new THREE.Clock();
    scene = new THREE.Scene();
    
    container = document.createElement('div');
    document.body.appendChild(container);

    //camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 20000);
    camera2 = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 1, 1500);
    camera2.position.set(0, 50, 100);
    camera2.lookAt(new THREE.Vector3());

    camera1 = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 1, 10000);
    camera1.position.z = 500;  // important
    camera1.position.y = 200;  // important
    // scene

    scene = new THREE.Scene();
    gridxz = new THREE.GridHelper (200, 20,'red','white');
    scene.add (gridxz);
    var ambient = new THREE.AmbientLight(0x444444);
    scene.add(ambient);

    var directionalLight = new THREE.DirectionalLight(0xffffff);
    directionalLight.position.set(0, 1, 1).normalize();
    scene.add(directionalLight);

    // model
    var onProgress = function(xhr) {
        if (xhr.lengthComputable) {
          var percentComplete = xhr.loaded / xhr.total * 100;
          console.log(Math.round(percentComplete, 2) + '% downloaded');
        }
    };
    var onError = function(xhr) {};
    //THREE.Loader.Handlers.add(/\.dds$/i, new THREE.DDSLoader());

    var mtlLoader = new THREE.MTLLoader();
    mtlLoader.setPath('model_by_Attila_Dobak/');
    mtlLoader.load('oldcar.mtl', function(materials) {
    materials.preload();
    var objLoader = new THREE.OBJLoader();
    objLoader.setMaterials(materials);
    objLoader.setPath('model_by_Attila_Dobak/');
    objLoader.load('oldcar.obj', function(object) {
        //var theObject =  unitize (object, 20);
        theObjectAll = unitize (object, 20);
        yellow_box = new THREE.BoxHelper (theObjectAll);
        scene.add (theObjectAll);				
        scene.add (yellow_box);
        //////// MATERIAL ADJUSTMENT for porsche ///////////////
        // transparent window: double-side fix
        object.traverse (
            function(mesh) {
				if (mesh instanceof THREE.Mesh) {
				    mesh.material.side = THREE.DoubleSide;
				}
            });
        }, onProgress, onError);

      });

    renderer = new THREE.WebGLRenderer();
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(window.innerWidth, window.innerHeight);
    container.appendChild(renderer.domElement);
	renderer.setClearColor (0x888888);

	controls = new THREE.OrbitControls(camera1, renderer.domElement);
	camera1.position.z = 200;
    window.addEventListener('resize', onWindowResize, false);
    speed = 0.0;
    angle = 0.0;
    
}

////////////////////////////////////////
// create an Object3D of the given object
// so that it is centered at +Y axis
// 
function unitize (object, targetSize) {  
	
	// find bounding box of 'object'
	var box3 = new THREE.Box3();
	box3.setFromObject (object);
	var size = new THREE.Vector3();
	size.subVectors (box3.max, box3.min);
	var center = new THREE.Vector3();
	center.addVectors(box3.max, box3.min).multiplyScalar (0.5);
	
	console.log ('center: ' + center.x + ', '+center.y + ', '+center.z );
	console.log ('size: ' + size.x + ', ' +  size.y + ', '+size.z );
	
	// uniform scaling according to objSize
	var objSize = findMax (size);
	var scaleSet = targetSize/objSize;
				
	var theObject =  new THREE.Object3D();
    theObject.add (object);
    
	object.scale.set (scaleSet, scaleSet, scaleSet);
	object.position.set (-center.x*scaleSet, -center.y*scaleSet + size.y/2*scaleSet, -center.z*scaleSet);
	return theObject;
	
	
	// helper function
	function findMax(v) {
		if (v.x > v.y) {
			return v.x > v.z ? v.x : v.z;
		} else { // v.y > v.x
			return v.y > v.z ? v.y : v.z;
		} 
	}
			
}

function onWindowResize() {
    camera1.aspect = window.innerWidth / window.innerHeight;
    camera1.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
}

function update(dt) {
    keyboard.update();
    if (keyboard.pressed("A")) {
        angle += 0.01;
    }
    if (keyboard.pressed("D")) {
        angle -= 0.01;
    }
    if (keyboard.pressed("W")) {
        speed -= 0.15;
    }
    if (keyboard.pressed("S")) {
        speed += 0.15;
    }
    if (keyboard.pressed("space")) {
        speed = 0.01;
    }
    speed = Math.clamp (speed, -50, 50.0);
    vel = new THREE.Vector3(speed,0,0);
    vel.applyAxisAngle (new THREE.Vector3(0,1,0), angle);
    pos.add (vel.clone().multiplyScalar(dt));
    //console.log(pos);
}

function animate() {
    let camera;
    if(theObjectAll) {
        camera2.position.copy(theObjectAll.localToWorld(new THREE.Vector3(-100, 50, 0)));
        camera2.lookAt(theObjectAll.position);
    }

    if(useOne) camera = camera1;
    else camera = camera2;

    var dt = clock.getDelta();
    update(dt);
    
    controls.update();
    requestAnimationFrame(animate);
    if(theObjectAll) {
        theObjectAll.children[0].position.copy(pos);
        theObjectAll.children[0].rotation.y = angle;
        //console.log(theObjectAll.children[0].rotation.y);
    }
    renderer.render(scene, camera1);
    yellow_box.update();
}

</script>
</body>

</html>